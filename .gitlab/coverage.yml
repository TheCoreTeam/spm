#
# Rule to gather the coverages from the different branches
#
---
coverage:
  stage: coverage
  tags: ["docker"]
  extends: .only-master-mr
  needs: [test_spm_seq_shm,test_spm_mpi_shm,test_spm_mpi_dist,
          test_wrapper_seq,test_wrapper_mpi]
  dependencies: [test_spm_seq_shm,test_spm_mpi_shm,test_spm_mpi_dist,
                 test_wrapper_seq,test_wrapper_mpi]
  script:
    - export INPUT_FILES=""
    - for name in $( ls -1 spm-*.lcov );
      do
        export INPUT_FILES="$INPUT_FILES -a $name";
      done
    - lcov $INPUT_FILES -o spm.lcov
    - lcov --summary spm.lcov
    - lcov_cobertura spm.lcov --output spm-coverage.xml
  coverage: /^\s*lines......:\s*\d+.\d+\%/
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 180 minutes
    paths:
      - spm.lcov
      - spm-*.lcov
      - spm-coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: spm-coverage.xml
